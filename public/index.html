<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redis Chat App</title>
</head>
<style>
    body { 
        font-family: Arial, sans-serif; 
        max-width: 700px; 
        margin: 30px auto; 
    }
    
    #messages { 
        border: 1px solid #ddd; 
        height: 400px; 
        overflow-y: auto; 
        padding: 10px;
    }
    
    .msg { 
        margin-bottom: 8px; 
        padding: 6px; 
        border-radius: 6px; 
        background: #f2f2f2; 
    }
    
    .meta { 
        font-size: 12px; 
        color: #666; 
        margin-bottom: 4px; 
    }
    
    #controls { 
        margin-top: 10px; 
        display:flex; 
        gap:8px; 
    }
    
    input, button { 
        padding:8px; 
        font-size: 14px; 
    }
    
    #username { 
        width: 150px; 
    }
    
    #text { 
        flex:1; 
        }
</style>
<body>
    <h2>Chat Application using Redis</h2>
    
    <div>
        <label>Username: <input id="username" placeholder="Your Name"></label>
    </div>
    
    <div id="messages"></div>

    <div id="controls">
        <input id="text" placeholder="Type a Message...">
        <button id="send">Send</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        const socket = io();
        const messagesEl = document.getElementById('messages');
        const usernameInput = document.getElementById('username');
        const textInput = document.getElementById('text');
        const sendBtn = document.getElementById('send');

        const shown = new Set();

        function addMessage(msg) {
            const key = (msg.ts || '') + '|' + (msg.username || '');
            if (shown.has(key)) return;
            shown.add(key);

            const dt = new Date(msg.ts || Date.now());
            const wrapper = document.createElement('div');
            wrapper.className = 'msg';
            wrapper.innerHTML = `
            <div class="meta"><strong>${escapeHtml(msg.username)}</strong> * ${dt.toLocaleString()}</div>
            <div>${escapeHtml(msg.text)}</div>
            `;

            messagesEl.appendChild(wrapper);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function sendMessage() {
            const username = (usernameInput.value || 'Anonymous').trim();
            const text = textInput.value.trim();

            if (!text) return;

            const msgObj = { username, text, ts: Date.now() };

            // send this to server via socket
            socket.emit('send_message', msgObj);
            textInput.value = '';
        }

        // Safety: Simple Escape
        function escapeHtml(s) {
            return String(s || '').replace(/[&<>"']/g, function(m) {
                return ({
                    '&':'&amp;',
                    '<':'&lt;',
                    '>':'&gt;',
                    '"':'&quot;',
                    "'":'&#39;'}[m]);
            });
        }

        // Receive Real-Time messages from Server
        socket.on('message', (msg) => {
            addMessage(msg);
        });

        // Whenever a new client connects, server sends 'history' (array of lat 20 messages)
        socket.on('history', (messages) => {
            if (!Array.isArray(messages)) return;
            // append oldest-first (server already sent oldest-first)
            messages.forEach((m) => addMessage(m));
        });

        sendBtn.addEventListener('click', sendMessage);
        textInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessage();
        })

    </script>

</body>
</html>